import{d as y}from"./chunks/debugTool.js";const fe=y("dom"),Y=(t,n)=>(fe.log("Querying multiple elements:",{root:t,sel:n}),Array.from(t.querySelectorAll(n))),f=(t,n,e,o)=>{t&&(fe.log("Attaching event listener:",{el:t,ev:n,opts:o}),t.addEventListener(n,e,o))},Ue=(t,n=300)=>{let e;return(...o)=>{fe.log("Debouncing function call with delay:",{fn:t,ms:n,args:o}),clearTimeout(e),e=setTimeout(()=>t(...o),n)}},m={courses:[],filtered:[],savedSchedules:[],sort:{key:null,dir:1},view:{panel:"list",semester:"first"}},Ce=y("shadowMount"),Me="Workday - Schedule Tool";function _e(){let t=document.getElementById(Me);return t?(Ce.log("Returning existing shadow root:",t),t.shadowRoot):(t=document.createElement("div"),t.id=Me,t.style.all="initial",t.style.position="fixed",t.style.bottom="16px",t.style.right="16px",t.style.zIndex="999999999",t.attachShadow({mode:"open"}),document.documentElement.appendChild(t),Ce.log("Mounted new extension container:",t),t.shadowRoot)}const Z=y("loadPanel");async function je(t){const n=chrome.runtime.getURL("src/panel.html"),e=["formatting/general.css","formatting/widget-shell.css","formatting/widget-buttons.css","formatting/floating-button.css","formatting/course-list.css","formatting/schedule-view.css","formatting/schedule-view-events.css","formatting/settings.css","colors/course-list-colors.css","colors/general-colors.css","colors/schedule-view-colors.css","colors/widget-functionality-colors.css","colors/settings-colors.css"];Z.log("Fetching HTML and CSS files...");const[o,...s]=await Promise.all([fetch(n).then(c=>c.text()),...e.map(c=>fetch(chrome.runtime.getURL(`src/css/${c}`)).then(g=>g.text()))]),r=s.join(`
`);Z.log("CSS files fetched and concatenated:",{cssParts:s}),t.innerHTML="";const l=document.createElement("style");if(l.textContent=r,t.appendChild(l),Z.log("Appended styles to shadow DOM."),!document.querySelector('link[href*="Material+Symbols"]')){const c=document.createElement("link");c.rel="stylesheet",c.href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200",document.head.appendChild(c),Z.log("Appended Material Symbols font to document head.")}const i=document.createElement("div");i.innerHTML=o,t.appendChild(i),Z.log("Appended HTML content to shadow DOM.");const d={button:t.querySelector("#floating-button"),widget:t.querySelector(".widget"),root:t,search:t.querySelector("#widget-search"),saveScheduleBtn:t.querySelector("#widget-save-schedule"),refresh:t.querySelector("#widget-refresh"),exportDropdown:t.querySelector("#widget-export"),exportButton:t.querySelector("#widget-export-button"),exportMenu:t.querySelector("#widget-export-menu"),helpBtn:t.querySelector(".help"),settingsBtn:t.querySelector(".settings"),tableBody:t.querySelector("tbody"),tableHead:t.querySelector("thead"),tabButtons:t.querySelectorAll(".tab-button"),panels:t.querySelectorAll(".widget-panel"),scheduleGrid:t.querySelector("#schedule-grid"),semesterButtons:t.querySelectorAll(".semester-button"),savedDropdown:t.querySelector("#schedule-saved-dropdown"),savedMenu:t.querySelector("#schedule-saved-menu"),footerConflicts:t.querySelector("#widget-conflicts"),saveModal:t.querySelector("#schedule-save-modal"),saveModalTitle:t.querySelector("#schedule-modal-title"),saveModalMessage:t.querySelector("#schedule-modal-message"),saveModalField:t.querySelector("#schedule-modal-field"),saveModalInput:t.querySelector("#schedule-modal-input"),saveModalCancel:t.querySelector(".schedule-modal-cancel"),saveModalConfirm:t.querySelector(".schedule-modal-confirm")};return Z.log("DOM elements loaded:",d),d}const le=y("headerMaps"),ge=t=>String(t||"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim().toLowerCase();function We(t){const e=(t?.getAttribute?.("data-automation-id")||"").match(/^columnHeader(\d+\.\d+)$/);return e?e[1]:null}function Ge(t){const n=Array.from(t.querySelectorAll('th[data-automation-id^="columnHeader"]'));le.log({id:"buildHeaderMaps.headers"},"Header elements found:",n.length);const e=n.map((i,d)=>{const c=Fe(i),g=We(i);return{el:i,pos:d,key:g,text:c,norm:ge(c)}}).filter(i=>i.text);le.log({id:"buildHeaderMaps.parsedHeaders"},"Parsed headers:",e.map(i=>({pos:i.pos,key:i.key,text:i.text,norm:i.norm})));function o(i){const d=i.map(ge);let c=e.find(g=>d.includes(g.norm));return c||(c=e.find(g=>d.some(a=>g.norm.includes(a))),c||null)}const s={instructor:["instructor","instructors"],meeting:["meeting patterns","meeting pattern"],deliveryMode:["delivery mode"],title:["title","course listing"],section:["section"],instructionalFormat:["instructional format"],startDate:["start date","start"]},r={},l={};for(const[i,d]of Object.entries(s)){const c=o(d);r[i]=c?c.key:null,l[i]=c?c.pos:-1,le.log({id:"buildHeaderMaps.map"},"Mapped header:",{key:i,needles:d,hit:c?{pos:c.pos,colKey:c.key,text:c.text}:null})}return{colMap:r,posMap:l}}function Fe(t){if(!t)return"";const n=t.querySelector("button[title]");return n?(n.getAttribute("title")||"").trim():(t.textContent||"").trim()}const z=y("sectionLinkInfo");function Ze(t){let n=String(t||"").replace(/\u00A0/g," ").trim();if(z.log({id:"parseSectionLinkString.input"},"Raw input:",t),!n)return null;n=n.replace(/\s*\n\s*/g," ").trim(),z.log({id:"parseSectionLinkString.normalized"},"Normalized string:",n);const e=n.match(/^\s*([A-Z][A-Z0-9_]*\s*\d{3}[A-Z]?)\s*-\s*(.+?)\s*$/);if(!e)return z.log({id:"parseSectionLinkString.noMatch"},"String did not match expected pattern"),null;const o=e[1].trim(),s=e[2].trim();z.log({id:"parseSectionLinkString.match"},"Regex match:",{baseCode:o,rest:s});const r=s.split(/\s*[-–—]\s*/).map(c=>c.trim()).filter(Boolean);let l="",i="";l=r[0],i=r.slice(1).join(" - ").trim(),i=i.replace(/\s*:\s*/g,`:
`);const d={code:o,section_number:l,title:i,full:n};return z.log({id:"parseSectionLinkString.result"},"Parsed section link result:",d),d}function ce(t){const n=String(t||"").match(/[A-Z][A-Z0-9_]*\s*\d{2,3}[A-Z]?/),e=n?n[0].replace(/\s+/g," ").trim():"";return z.log({id:"guessClassCode"},"Guessed class code:",{input:t,out:e}),e}const R=y("meetingPatternsInfo");function ze(t){if(!t)return R.log({id:"extractMeetingLinesFromCell.missing"},"No meeting element provided"),[];let e=Array.from(t.querySelectorAll('[data-automation-id="menuItem"][aria-label]')).map(i=>(i.getAttribute("aria-label")||"").trim()).filter(Boolean);R.log({id:"extractMeetingLinesFromCell.menuItems"},"Menu item lines:",{count:e.length}),e.length||(e=Array.from(t.querySelectorAll('[data-automation-id="promptOption"]')).map(d=>(d.getAttribute("data-automation-label")||d.getAttribute("title")||d.textContent||"").trim()).filter(Boolean),R.log({id:"extractMeetingLinesFromCell.prompts"},"PromptOption lines (fallback):",{count:e.length})),e.length||(e=String(t.innerText||"").split(`
`).map(i=>i.trim()).filter(Boolean),R.log({id:"extractMeetingLinesFromCell.innerText"},"InnerText lines (final fallback):",{count:e.length}));const o=/\b\d{4}-\d{2}-\d{2}\s*-\s*\d{4}-\d{2}-\d{2}\b/,s=/\b\d{1,2}:\d{2}\s*[ap]\.?m\.?\b/i,r=/\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/i,l=e.filter(i=>o.test(i)&&s.test(i)&&r.test(i));return R.log({id:"extractMeetingLinesFromCell.filtered"},"Filtered meeting lines:",{before:e.length,after:l.length}),l}function Ye(t){if(!t)return[];const e=Array.from(t.querySelectorAll('[data-automation-id="menuItem"][aria-label]')).map(i=>(i.getAttribute("aria-label")||"").trim()).filter(Boolean);R.log({id:"extractMeetingLinesFromRow.items"},"Row menu item lines:",{count:e.length});const o=/\b\d{4}-\d{2}-\d{2}\s*-\s*\d{4}-\d{2}-\d{2}\b/,s=/\b\d{1,2}:\d{2}\s*[ap]\.?m\.?\b/i,r=/\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/i,l=e.filter(i=>o.test(i)&&s.test(i)&&r.test(i));return R.log({id:"extractMeetingLinesFromRow.filtered"},"Filtered row meeting lines:",{before:e.length,after:l.length}),l}function Ve(t){const n=String(t||""),e=n.split("|").map(u=>u.trim()).filter(Boolean),s=(e.find(u=>/\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/.test(u))||"").split(/\s+/).join(" / "),r=e.find(u=>/\d{1,2}:\d{2}/.test(u)&&/-/.test(u))||"",l=e.find(u=>/\([A-Z]{2,}\)/.test(u))||"",i=n.match(/\bfloor\b\s*[:\-]?\s*(-?[A-Za-z0-9]+)/i),d=n.match(/\b(room|rm)\b\s*[:\-]?\s*([A-Za-z0-9]+)/i),c=i?`Floor: ${i[1]}`:"",g=d?`Room: ${d[2]}`:"",a={days:s,time:r,location:[l,[c,g].filter(Boolean).join(" | ")].filter(Boolean).join(`
`)};return R.log({id:"formatMeetingLineForPanel"},"Formatted meeting line:",{raw:n,formatted:a}),a}function Xe(t){const n=String(t||"").split(/\r?\n/).map(e=>e.replace(/\s+/g," ").trim()).filter(Boolean).join(`
`);return R.log({id:"normalizeMeetingPatternsText"},"Normalized meeting patterns text:",{beforeLen:String(t||"").length,afterLen:n.length}),n}function he(t){const n=String(t||"").match(/\b(\d{4}-\d{2}-\d{2})\b/),e=n?n[1]:"";return R.log({id:"extractStartDate"},"Extracted start date:",{line:t,out:e}),e}const we=y("instructorInfo");function Ke(t){if(!t)return we.log({id:"extractInstructorNamesFromCell.missing"},"No instructor element provided"),"";const n=t.querySelector('[data-automation-id="promptOption"]'),e=(n&&(n.getAttribute("data-automation-label")||n.getAttribute("title")||n.textContent)||t.textContent||"").trim();return we.log({id:"extractInstructorNamesFromCell.result"},"Extracted instructor text:",{hasPrompt:!!n,txt:e}),e}const de=y("onlineClassCheck");function Je(t){if(!t)return de.log({id:"onlineClassCheck.missing"},"No delivery mode cell provided"),!1;const n=(t.innerText||t.textContent||"").trim();if(/online learning/i.test(n))return de.log({id:"onlineClassCheck.match.direct"},"Matched online learning from cell text",n),!0;const e=Array.from(t.querySelectorAll('[data-automation-id="promptOption"]')),o=e.some(s=>{const r=(s.getAttribute("data-automation-label")||s.getAttribute("title")||s.textContent||"").trim();return/online learning/i.test(r)});return de.log({id:"onlineClassCheck.match.prompts"},"Checked prompt options for online learning",{promptCount:e.length,matched:o}),o}const se=y("findingTables");function Qe(){const t=Y(document,'table, [role="table"], div[data-automation-id*="grid"], div[role="grid"]');se.log({id:"findingTables.roots"},"Candidate roots found:",t.length);for(const n of t){const e=Y(n,"thead th, [role='columnheader'], .wd-GridHeaderCell, .grid-column-header"),o=e.map(l=>ge(Fe(l))),s=o.some(l=>l.includes("section"))&&(o.some(l=>l.includes("instructor"))||o.some(l=>l.includes("meeting"))||o.some(l=>l.includes("instructional format"))||o.some(l=>l.includes("format"))||o.some(l=>l.includes("status")));if(se.log({id:"findingTables.scanRoot"},"Scanning root:",{headerCount:e.length,looksRight:s,headerText:o}),!s)continue;const r=Y(n,"tbody tr, [role='rowgroup'] [role='row'], .wd-GridRow, .grid-row");if(se.log({id:"findingTables.rows"},"Rows found for matching root:",r.length),r.length)return{root:n,rows:r}}return se.log({id:"findingTables.none"},"No matching table/grid found"),null}const A=y("courseExtraction");async function Le(){A.log({id:"extractAllCourses.start"},"Starting course extraction");const t=Qe();let n=[];if(A.log({id:"extractAllCourses.tables"},"findingTables() result:",t?{hasRoot:!!t.root,rowCount:t.rows?.length||0}:null),t){const o=Ge(t.root);A.log({id:"extractAllCourses.headerMaps"},"Built header maps:",o);for(const s of t.rows){const r=tt(s,o);(r.code||r.title)&&Object.values(r).join("").trim()&&n.push(r)}}const e=et(n);return A.log({id:"extractAllCourses.done"},"Extraction complete:",{total:n.length,unique:e.length}),e}function et(t){const n=s=>[s.code,s.title,s.section_number].join("|").toLowerCase(),e=new Set,o=[];for(const s of t){const r=n(s);e.has(r)||(e.add(r),o.push(s))}return A.log({id:"findUniqueCourses"},"Deduped courses:",{in:t.length,out:o.length,removed:t.length-o.length}),o}function tt(t,n){const{colMap:e,posMap:o}=n,s=Y(t,"td, [role='gridcell']"),r=(t.innerText||"").trim();A.log({id:"extractFromRow.start"},"Extracting row:",{cellCount:s.length,textLen:r.length});function l(h){const ve=(h.querySelector('[id^="gen-dwr-comp-"]')?.id||"").match(/^gen-dwr-comp-(\d+\.\d+)-/);return ve?ve[1]:null}const i=new Map;s.forEach(h=>{const w=l(h);w&&!i.has(w)&&i.set(w,h)});const d=h=>{const w=e[h];if(w!=null&&i.has(w))return i.get(w);const I=o[h];return I!=null&&I>=0&&I<s.length?s[I]:null},c=h=>{const w=e[h];if(w!=null&&i.has(w))return(i.get(w).innerText||"").trim();const I=o[h];return I!=null&&I>=0&&I<s.length?(s[I].innerText||"").trim():""},g=Y(t,'[data-automation-id="promptOption"]');let a=null;for(const h of g){const w=h.getAttribute("data-automation-label")||h.getAttribute("title")||h.getAttribute("aria-label")||h.textContent||"";if(/^[A-Z][A-Z0-9_]*\s*\d{2,3}-/.test(w)){a=h;break}}!a&&g.length>0&&(a=g[0]);const u=a&&(a.getAttribute("data-automation-label")||a.getAttribute("title")||a.getAttribute("aria-label")||a.textContent)||"";A.log({id:"extractFromRow.sectionLink"},"Section link:",{promptOptions:g.length,hasMatch:!!a,sectionLinkString:u});const b=c("title"),p=c("code"),S=c("section"),v=c("meeting"),E=c("instructionalFormat"),x=c("startDate");let N="",k=b||"",X="";const K=Ze(u);K&&(N=K.code,X=K.section_number,k=K.title),N||(N=ce(p)||ce(b)||ce(r)||""),A.log({id:"extractFromRow.coreParse"},"Core parse result:",{code:N,title:k,section_number:X,titleCell:b,codeCell:p,sectCell:S});const C=h=>/\b(lab|laboratory|labratory)\b/i.test(String(h||"")),q=h=>/\bseminar\b/i.test(String(h||"")),H=h=>/\bdiscussion\b/i.test(String(h||"")),J=C(E)||C(S)||C(k)||C(u)||C(r),M=q(E)||q(S)||q(k)||q(u)||q(r),j=H(E)||H(S)||H(k)||H(u)||H(r);A.log({id:"extractFromRow.typeDetection"},"Type flags:",{isLab:J,isSeminar:M,isDiscussion:j,instructionalFormatCell:E});const W=d("instructor");let G="";J||M?G="N/A":G=Ke(W)||(c("instructor")||"").trim();let F;const ae=e.meeting;let oe=null;ae!=null&&i.has(ae)?oe=i.get(ae):o.meeting!=null&&o.meeting>=0&&o.meeting<s.length&&(oe=s[o.meeting]);let U=oe?ze(oe):[];U.length||(U=Ye(t));let $={days:"",time:"",location:""},be=he(U[0])||he(x);if(U.length){const h=U[0];$=Ve(h)}else F=(v||"").trim();const qe=d("deliveryMode"),ye=Je(qe);ye&&($.location="Online"),$.days||$.time||$.location?(F=[$.days,$.time].filter(Boolean).join(" | "),$.location?F+=`
${$.location}`:F+=`
Online`):F=(v||"").trim(),A.log({id:"extractFromRow.meeting"},"Meeting parse:",{startDateCell:x,startDate:be,linesCount:U.length,isOnlineDelivery:ye,meetingObj:$,meeting:F});const He=(E||"").trim(),T={code:N,title:k,section_number:X,instructor:G,meeting:Xe(F),instructionalFormat:He,startDate:be,meetingLines:U,isLab:J,isSeminar:M,isDiscussion:j};return A.log({id:"extractFromRow.result"},"Extracted course:",{code:T.code,title:T.title,section_number:T.section_number,instructor:T.instructor,instructionalFormat:T.instructionalFormat,startDate:T.startDate,meetingLines:T.meetingLines?.length||0,isLab:T.isLab,isSeminar:T.isSeminar,isDiscussion:T.isDiscussion}),T}const te=y("renderRows"),Ee=t=>{const n=String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");return te.log("Escaped HTML:",{input:t,output:n}),n};function nt(t){const n=String(t||"").replace(/[\u00A0\u200B-\u200D\uFEFF]/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n[ \t]+/g,`
`).replace(/\n{2,}/g,`
`).trim();return te.log("Cleaned text lines:",{input:t,output:n}),n}function Q(t,n){te.log("Rendering rows:",n),t.tableBody.innerHTML="";const e=document.createDocumentFragment();n.forEach(o=>{const s=document.createElement("tr"),r=o.isLab?"[Laboratory]":o.isSeminar?"[Seminar]":o.isDiscussion?"[Discussion]":"";s.innerHTML=`
      <td class="title">
        <div class="title-main">${o.title||""}</div>
        ${r?`<div class="muted">${r}</div>`:""}
      </td>
      <td class="code">${o.code||""}</td>
      <td class="sect">${(o.section_number||"").trim()}</td>
      <td class="instructor">${o.instructor||""}</td>
      <td class="meeting">
        ${(()=>{const l=nt(o.meeting).split(`
`),i=(l[0]||"").trim(),d=l.slice(1).map(c=>c.replace(/[\u00A0\u200B-\u200D\uFEFF]/g,"").trim()).filter(Boolean).join(`
`);return te.log("Processed meeting details:",{main:i,sub:d}),`
            ${i?`<span class="meeting-pill">${Ee(i).trim()}</span>`:""}
            ${d?`<div class="meeting-sub">${Ee(d).trim()}</div>`:""}
          `})()}
      </td>
      <td class="instructionalFormat">${o.instructionalFormat||""}</td>
    `,e.appendChild(s)}),t.tableBody.appendChild(e),te.log("Rows rendered and added to table body.")}const P=y("panelInteractions");function xe(t){if(t=(t||"").trim().toLowerCase(),P.log("Search query received:",t),!t){m.filtered=[...m.courses],P.log("Search filter cleared, resetting filtered courses:",m.filtered);return}m.filtered=m.courses.filter(n=>["code","title","section_number","instructor","meeting","instructionalFormat"].some(e=>(n[e]||"").toLowerCase().includes(t))),P.log("Search filter applied, filtered courses:",m.filtered)}function ee(t){if(!t)return;const n=m.sort.key===t?-m.sort.dir:1;m.sort={key:t,dir:n},P.log("Sorting by key:",t,"Direction:",n);const e=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});m.filtered.sort((o,s)=>n*e.compare(o[t]||"",s[t]||"")),P.log("Sorted filtered courses:",m.filtered)}function ot(t){const n=Y(t.tableHead,"th[data-key]");P.log("Table header cells with sorting keys:",n),n.forEach(e=>{f(e,"click",()=>{const o=e.getAttribute("data-key");P.log("Sorting header clicked, sorting by:",o),ee(o),Q(t,m.filtered),n.forEach(s=>s.classList.remove("sorted-asc","sorted-desc")),e.classList.add(m.sort.dir===1?"sorted-asc":"sorted-desc"),P.log("Updated sorting classes:",{sortedAsc:e.classList.contains("sorted-asc"),sortedDesc:e.classList.contains("sorted-desc")})})})}const B=y("scheduleView"),V=["Mon","Tue","Wed","Thu","Fri"],Be=8,Se=21,re=30,_=[];for(let t=Be;t<Se;t++)_.push(t*60),_.push(t*60+30);_.push(Se*60);const st=/\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/g,rt=/(\d{1,2}):(\d{2})\s*([ap])\.?m\.?/gi,Te={first:["09","08"],second:["01","12"]};function De(t){if(!t)return null;const n=t.trim().match(/(\d{1,2}):(\d{2})\s*([ap])\.?m\.?/i);if(!n)return null;let e=Number.parseInt(n[1],10);const o=Number.parseInt(n[2],10),s=n[3].toLowerCase();return s==="p"&&e!==12&&(e+=12),s==="a"&&e===12&&(e=0),e*60+o}function it(t){const n=String(t||"").match(st)||[],e=String(t||"").match(rt)||[];if(n.length===0||e.length<2)return null;const o=De(e[0]),s=De(e[1]);return o==null||s==null||s<=o?null:(B.log("Parsed meeting line:",{days:n,timeTokens:e,startMinutes:o,endMinutes:s}),{days:[...new Set(n)],startMinutes:o,endMinutes:s,timeLabel:`${e[0]} - ${e[1]}`})}function at(t){if(!t)return null;const n=t.split("-")[1],e=Te.first.includes(n)?"first":Te.second.includes(n)?"second":null;return B.log("Determined semester for startDate:",{startDate:t,semester:e}),e}function Ae(t){const n=Be*60,e=Se*60;return Math.max(n,Math.min(e,t))}function lt(t){return Math.floor(t/re)*re}function ct(t){return Math.ceil(t/re)*re}function $e(t){return _.indexOf(t)}function dt(t,n){B.log("Building day events for semester:",n);const e=new Map;V.forEach(r=>e.set(r,[]));const o=new Set;let s=0;return t.forEach(r=>{const l=r.startDate||he(r.meetingLines?.[0])||"";if(at(l)!==n)return;const d=r.meetingLines?.length?r.meetingLines:[],c=r.isLab?"[Laboratory]":r.isSeminar?"[Seminar]":r.isDiscussion?"[Discussion]":"";d.forEach(g=>{const a=it(g);if(!a)return;let u=Ae(a.startMinutes),b=Ae(a.endMinutes);u=lt(u),b=ct(b);const p=$e(u),S=$e(b);if(p===-1||S===-1||S<=p)return;const v=S-p;a.days.forEach(E=>{if(!e.has(E))return;const x=[E,r.code||"",r.title||"",a.timeLabel,p,v].join("|");o.has(x)||(o.add(x),e.get(E).push({id:s++,code:r.code||"",title:r.title||"",label:c,timeLabel:a.timeLabel,rowStart:p,rowSpan:v,startIdx:p,endIdx:S}))})})}),V.forEach(r=>{e.get(r).sort((l,i)=>l.startIdx-i.startIdx||l.endIdx-i.endIdx)}),B.log("Built day events:",e),e}function ut(t){B.log("Adding conflicts to events...");const n=new Map;return V.forEach(e=>{const o=(t.get(e)||[]).slice().sort((i,d)=>i.startIdx-d.startIdx||i.endIdx-d.endIdx),s=[];let r=null,l=null;for(let i=0;i<_.length-1;i++){const d=o.filter(g=>g.startIdx<=i&&g.endIdx>i),c=d.length?d.map(g=>g.id).sort((g,a)=>g-a).join("|"):null;if(!c){r&&s.push(r),r=null,l=null;continue}if(r&&c===l){r.end=i+1;continue}r&&s.push(r),r={start:i,end:i+1,events:d,hasConflict:d.length>1},l=c}r&&s.push(r),n.set(e,s)}),B.log("Grouped events with conflicts:",n),n}function mt(t){const n=new Set,e=[];return t.forEach(o=>{o.forEach(s=>{if(!s.hasConflict)return;const r=[...new Set(s.events.map(i=>i.code||i.title).filter(Boolean))];if(r.length<2)return;r.sort((i,d)=>i.localeCompare(d));const l=r.join("|");n.has(l)||(n.add(l),e.push(r))})}),B.log("Conflict summaries:",e),e}function gt(t,n){if(!t?.footerConflicts)return;if(!n.length){t.footerConflicts.textContent="";return}const e=n.map(o=>`[${o.join(", ")}]`).join(" ");t.footerConflicts.textContent=`⚠️ The following classes are in conflict: ${e}`}function ht(t){const n=Math.floor(t/60),e=t%60,o=String(n),s=String(e).padStart(2,"0");return`${o}:${s}`}function pt(){const t=document.createElement("div");t.className="schedule-table-wrap";const n=document.createElement("table");n.className="schedule-table";const e=document.createElement("thead"),o=document.createElement("tr");o.innerHTML=`
    <th class="schedule-time"></th>
    ${V.map(l=>`<th class="schedule-day-head" data-day="${l}">${l}</th>`).join("")}
  `,e.appendChild(o),n.appendChild(e);const s=document.createElement("tbody");for(let l=0;l<_.length;l++){const i=document.createElement("tr"),d=document.createElement("td");d.className="schedule-time",d.textContent=ht(_[l]),i.appendChild(d),V.forEach(c=>{const g=document.createElement("td");g.className="schedule-cell",g.dataset.day=c,g.dataset.row=String(l);const a=document.createElement("div");a.className="schedule-cell-inner",g.appendChild(a),i.appendChild(g)}),s.appendChild(i)}n.appendChild(s),t.appendChild(n);const r=document.createElement("div");return r.className="schedule-overlay",t.appendChild(r),t}function ft(t){return t.getBoundingClientRect()}function St(t,n,e){const o=t.querySelector(".schedule-overlay");o.innerHTML="";const s=t.querySelector(".schedule-table"),r=s.querySelector("tbody tr"),l=s.querySelector('tbody tr td.schedule-cell[data-day="Mon"]'),i=s.querySelector("thead th.schedule-time");if(!r||!l||!i)return;const d=i.getBoundingClientRect().width,c=l.getBoundingClientRect().width,g=s.querySelector("thead").getBoundingClientRect().height,a=r.getBoundingClientRect().height,u=getComputedStyle(l),b=parseFloat(u.borderLeftWidth)||0,p=parseFloat(u.borderTopWidth)||0,S=parseFloat(u.borderRightWidth)||0,v=parseFloat(u.borderBottomWidth)||0,E=(b+S)/2,x=(p+v)/2,N=[];V.forEach((k,X)=>{(n.get(k)||[]).forEach(C=>{const q=d+X*c,H=g+C.rowStart*a,J=C.rowSpan*a,M=document.createElement("div");M.className="schedule-entry-float",M.style.left=`${q+b}px`,M.style.top=`${H+p}px`,M.style.width=`${c-E}px`,M.style.height=`${J-x}px`;const j=document.createElement("div");j.className="schedule-entry-overlap-layer",M.appendChild(j);const W=document.createElement("div");W.className="schedule-entry-text";const G=C.code||C.title,F=C.label?`${G} ${C.label}`:G;W.innerHTML=`
        <div class="schedule-entry-title">${F}</div>
        <div class="schedule-entry-time">${C.timeLabel}</div>
      `,M.appendChild(W),o.appendChild(M),N.push({el:M,day:k,ev:C,rect:ft(M),overlapLayerEl:j,overlaps:[],textEl:W})})}),B.log("Rendered overlay blocks:",N)}function bt(t,n,e){const o=t?.scheduleRoot||t?.schedulePanel||t?.scheduleContainer||t?.scheduleView||t?.schedule;if(!o){B.warn("renderSchedule: no schedule host found on ctx");return}const s=dt(n||[],e),r=ut(s),l=mt(r);o.innerHTML="";const i=pt();o.appendChild(i),St(i,s),gt(t,l)}const O=y("export-ics"),ue="America/Vancouver",yt=t=>{const n=t.getUTCFullYear(),e=pad(t.getUTCMonth()+1),o=pad(t.getUTCDate()),s=pad(t.getUTCHours()),r=pad(t.getUTCMinutes()),l=pad(t.getUTCSeconds());return O.log("Formatting UTC Date:",{y:n,m:e,d:o,hh:s,mm:r,ss:l}),`${n}${e}${o}T${s}${r}${l}Z`},Ne={Mon:"MO",Tue:"TU",Wed:"WE",Thu:"TH",Fri:"FR",Sat:"SA",Sun:"SU"},vt=/(\d{4}-\d{2}-\d{2})\s*-\s*(\d{4}-\d{2}-\d{2})/,Ct=/(\d{1,2}):(\d{2})\s*([ap])\.?m\.?\s*-\s*(\d{1,2}):(\d{2})\s*([ap])\.?m\.?/i,Mt=/\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/g,ie=t=>String(t).padStart(2,"0"),wt=t=>{const n=t.getFullYear(),e=ie(t.getMonth()+1),o=ie(t.getDate());return O.log("Formatted Date:",{year:n,month:e,day:o}),`${n}${e}${o}`},Ie=t=>{const n=wt(t),e=ie(t.getHours()),o=ie(t.getMinutes());return O.log("Formatted DateTime:",{datePart:n,hours:e,minutes:o}),`${n}T${e}${o}00`},Re=(t,n,e)=>{let o=Number.parseInt(t,10);const s=Number.parseInt(n,10),r=e.toLowerCase();return O.log("Parsing Time:",{hours:o,minutes:s,period:r}),r==="p"&&o!==12&&(o+=12),r==="a"&&o===12&&(o=0),{hours:o,minutes:s}},Lt=t=>{const n=String(t||"").match(vt),e=String(t||"").match(Ct),o=String(t||"").match(Mt)||[];if(!n||!e||!o.length)return null;O.log("Parsed Meeting Line:",{dateMatch:n,timeMatch:e,days:o});const s=n[1],r=n[2],l=Re(e[1],e[2],e[3]),i=Re(e[4],e[5],e[6]),d=[...new Set(o.map(c=>Ne[c]).filter(Boolean))];return{startDate:s,endDate:r,days:d,startTime:l,endTime:i}},Et=t=>{const n=String(t||"").split("|").map(s=>s.trim()).filter(Boolean),e=n.find(s=>/\([A-Z]{2,}\)/.test(s));if(e)return e;const o=n.find(s=>/online/i.test(s));return o||""},xt=(t,n)=>{const e=new Date(`${t}T00:00:00`);for(let o=0;o<7;o+=1){const s=new Date(e);s.setDate(e.getDate()+o);const r=Object.values(Ne)[s.getDay()===0?6:s.getDay()-1];if(n.includes(r))return s}return e},Tt=(t,n)=>{const e=Lt(n);if(!e)return null;const o=xt(e.startDate,e.days),s=new Date(o);s.setHours(e.startTime.hours,e.startTime.minutes,0,0);const r=new Date(o);r.setHours(e.endTime.hours,e.endTime.minutes,0,0);const l=[t.code,t.title].filter(Boolean),i=[t.title?`Title: ${t.title}`:null,t.code?`Code: ${t.code}`:null,t.section_number?`Section: ${t.section_number}`:null,t.instructor?`Instructor: ${t.instructor}`:null,t.instructionalFormat?`Format: ${t.instructionalFormat}`:null,t.meeting?`Meeting: ${t.meeting}`:null].filter(Boolean),d=new Date(`${e.endDate}T23:59:59`),c=yt(d);return O.log("Built Class Event:",{course:t,parsed:e,startDate:s,endDate:r,summaryParts:l,descriptionLines:i,untilDate:c}),{uid:`${t.code||"course"}-${Date.now()}-${Math.random().toString(16).slice(2)}`,summary:l.join(" - ")||"Scheduled Course",description:i.join("\\n"),location:Et(n),dtstart:Ie(s),dtend:Ie(r),rrule:`FREQ=WEEKLY;BYDAY=${e.days.join(",")};UNTIL=${c}`}},Dt=t=>{const n=[];t.forEach(o=>{(o.meetingLines?.length?o.meetingLines:[]).forEach(r=>{const l=Tt(o,r);l&&n.push(l)})});const e=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Workday Extension//Schedule Export//EN","CALSCALE:GREGORIAN",`X-WR-TIMEZONE:${ue}`];return n.forEach(o=>{e.push("BEGIN:VEVENT"),e.push(`UID:${o.uid}`),e.push(`SUMMARY:${o.summary}`),o.description&&e.push(`DESCRIPTION:${o.description}`),o.location&&e.push(`LOCATION:${o.location}`),e.push(`DTSTART;TZID=${ue}:${o.dtstart}`),e.push(`DTEND;TZID=${ue}:${o.dtend}`),e.push(`RRULE:${o.rrule}`),e.push("END:VEVENT")}),e.push("END:VCALENDAR"),O.log("ICS File Generated:",e),e.join(`\r
`)};function At(){const t=Dt(m.filtered||[]),n=new Blob([t],{type:"text/calendar;charset=utf-8"}),e=URL.createObjectURL(n),o=document.createElement("a");o.href=e,o.download="workday-schedule.ics",document.body.appendChild(o),o.click(),O.log("Download Triggered for ICS file"),setTimeout(()=>{URL.revokeObjectURL(e),o.remove()},100)}const L=y("scheduleStorage"),ne="wdSavedSchedules",Pe=6,$t=t=>typeof structuredClone=="function"?structuredClone(t):JSON.parse(JSON.stringify(t||[])),pe=t=>Array.isArray(t)?t.filter(n=>n&&Array.isArray(n.courses)).map(n=>({id:n.id,name:n.name||"Untitled",savedAt:n.savedAt||new Date().toISOString(),courses:n.courses})):[],Oe=typeof chrome<"u"&&chrome.storage&&chrome.storage.local;async function It(){if(L.log("Loading saved schedules..."),Oe)return new Promise(t=>{chrome.storage.local.get([ne],n=>{const e=pe(n?.[ne]||[]);L.log("Schedules loaded from Chrome Storage:",e),t(e)})});try{const t=localStorage.getItem(ne);if(!t)return L.log("No schedules found in localStorage."),[];const n=pe(JSON.parse(t));return L.log("Schedules loaded from localStorage:",n),n}catch(t){return console.warn("[WD] Failed to load saved schedules",t),L.error("Error loading schedules from localStorage:",t),[]}}async function ke(t){const n=pe(t);if(L.log("Persisting saved schedules:",n),Oe)return new Promise(e=>{chrome.storage.local.set({[ne]:n},()=>{L.log("Schedules saved to Chrome Storage."),e()})});try{localStorage.setItem(ne,JSON.stringify(n)),L.log("Schedules saved to localStorage.")}catch(e){console.warn("[WD] Failed to save schedules",e),L.error("Error saving schedules to localStorage:",e)}}function Rt(t,n){const o={id:typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,name:t||"Untitled",savedAt:new Date().toISOString(),courses:$t(n||[])};return L.log("Created schedule snapshot:",o),o}function kt(t){const n=t.courses?.length||0,e=new Date(t.savedAt),o=Number.isNaN(e.getTime())?t.savedAt:e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});return`${n} courses · Saved ${o}`}function me(t,n){if(L.log("Rendering saved schedules:",n),!!t.savedMenu){if(t.savedMenu.innerHTML="",!n.length){const e=document.createElement("div");e.className="schedule-saved-empty",e.textContent="No saved schedules yet.",t.savedMenu.appendChild(e),L.log("No saved schedules to render.");return}n.forEach(e=>{const o=document.createElement("div");o.className="schedule-saved-card",o.dataset.id=e.id;const s=document.createElement("div");s.className="schedule-saved-card-header";const r=document.createElement("div"),l=document.createElement("div");l.className="schedule-saved-title",l.textContent=e.name;const i=document.createElement("div");i.className="schedule-saved-meta",i.textContent=kt(e),r.appendChild(l),r.appendChild(i),s.appendChild(r);const d=document.createElement("div");d.className="schedule-saved-actions";const c=document.createElement("button");c.type="button",c.className="schedule-saved-action",c.dataset.action="load",c.textContent="Load";const g=document.createElement("button");g.type="button",g.className="schedule-saved-action delete",g.dataset.action="delete",g.textContent="Delete",d.appendChild(c),d.appendChild(g),o.appendChild(s),o.appendChild(d),t.savedMenu.appendChild(o),L.log("Rendered schedule card:",e)})}}function Ft(t){return L.log("Checking if more schedules can be saved. Current count:",t.length),t.length<Pe}function Bt(){return Pe}const D=y("content");(()=>{async function t(){const n=_e(),e=await je(n);D.log("Loaded panel context:",e),e.button.classList.toggle("is-collapsed",e.widget.classList.contains("is-hidden"));const o=()=>{bt(e,m.filtered,m.view.semester),D.log("Schedule updated with filtered data:",m.filtered)},s=a=>{m.view.panel=a,D.log("Panel state changed:",a),e.panels.forEach(u=>{u.classList.toggle("is-active",u.dataset.panel===a)}),e.tabButtons.forEach(u=>{u.classList.toggle("is-active",u.dataset.panel===a)}),e.widget.classList.toggle("is-schedule-view",a==="schedule"),e.widget.classList.toggle("is-settings-view",a==="settings"),e.widget.classList.toggle("is-help-view",a==="help")},r=()=>{e.widget.classList.toggle("is-hidden"),D.log("Widget visibility toggled:",e.widget.classList.contains("is-hidden")),e.button.classList.toggle("is-collapsed",e.widget.classList.contains("is-hidden"))};let l=null;const i=a=>{e.saveModal&&(e.saveModal.classList.add("is-hidden"),e.saveModal.setAttribute("aria-hidden","true"),l&&(l(a),l=null),D.log("Schedule modal closed with value:",a))},d=({title:a,message:u,confirmLabel:b="Save",showInput:p=!0,showCancel:S=!0})=>e.saveModal?(e.saveModalTitle.textContent=a,e.saveModalMessage.textContent=u,e.saveModalConfirm.textContent=b,e.saveModalField.classList.toggle("is-hidden",!p),e.saveModalCancel.classList.toggle("is-hidden",!S),e.saveModalInput.value="",e.saveModalInput.classList.remove("is-invalid"),e.saveModal.classList.remove("is-hidden"),e.saveModal.setAttribute("aria-hidden","false"),p?e.saveModalInput.focus():e.saveModalConfirm.focus(),D.log("Opened schedule modal with title:",a),new Promise(v=>{l=v})):Promise.resolve(null);e.saveModal&&(f(e.saveModal,"click",a=>{if(a.target===e.saveModal){i(null);return}const u=a.target.closest("[data-action]")?.dataset.action;if(u){if(u==="close"||u==="cancel"){i(null);return}if(u==="confirm"){if(!e.saveModalField.classList.contains("is-hidden")){const b=e.saveModalInput.value.trim();if(!b){e.saveModalInput.classList.add("is-invalid"),e.saveModalInput.focus();return}i(b);return}i(!0)}}}),f(e.saveModalInput,"input",()=>{e.saveModalInput.classList.remove("is-invalid")}),f(e.saveModalInput,"keydown",a=>{a.key==="Enter"&&e.saveModalConfirm.click()}),f(document,"keydown",a=>{a.key==="Escape"&&e.saveModal&&!e.saveModal.classList.contains("is-hidden")&&i(null)})),e.tabButtons.forEach(a=>{f(a,"click",()=>{s(a.dataset.panel),a.dataset.panel==="schedule"&&o()})}),e.semesterButtons.forEach(a=>{f(a,"click",()=>{m.view.semester=a.dataset.semester,D.log("Semester state changed:",m.view.semester),e.semesterButtons.forEach(u=>{u.classList.toggle("is-active",u.dataset.semester===m.view.semester)}),o()})}),f(e.button,"click",r);const c=a=>{!e.exportDropdown||!e.exportButton||(e.exportDropdown.classList.toggle("is-open",a),e.exportButton.setAttribute("aria-expanded",String(a)),D.log("Export dropdown state changed:",a))};f(e.exportButton,"click",()=>{const a=e.exportDropdown?.classList.contains("is-open");c(!a)}),f(document,"click",a=>{!e.exportDropdown?.classList.contains("is-open")||(a.composedPath?a.composedPath():[]).includes(e.exportDropdown)||c(!1)}),f(document,"click",a=>{!e.savedDropdown?.open||(a.composedPath?a.composedPath():[]).includes(e.savedDropdown)||(e.savedDropdown.open=!1)}),f(e.root,"click",a=>{!e.exportDropdown?.open||(a.composedPath?a.composedPath():[]).includes(e.exportDropdown)||(e.exportDropdown.open=!1)}),chrome.runtime.onMessage.addListener(a=>{a?.type==="TOGGLE_WIDGET"&&(r(),D.log("Widget toggled by runtime message"))}),f(e.refresh,"click",async()=>{m.courses=await Le(),xe(e.search.value),ee(m.sort.key||"code"),Q(e,m.filtered),o(),D.log("Courses refreshed and schedule updated")});const g=async a=>{a==="ics"&&(At(),D.log("Export triggered for ICS file"))};f(e.exportMenu,"click",async a=>{const u=a.target.closest("[data-export]");u&&(c(!1),await g(u.dataset.export))}),f(e.saveScheduleBtn,"click",async()=>{if(!Ft(m.savedSchedules)){await d({title:"Schedule limit reached",message:`You can only save up to ${Bt()} schedules. Delete one to save another.`,confirmLabel:"Got it",showInput:!1,showCancel:!1});return}const a=await d({title:"Save schedule",message:"Name this schedule so you can find it later.",confirmLabel:"Save",showInput:!0,showCancel:!0});if(!a)return;const u=Rt(a,m.filtered);m.savedSchedules=[u,...m.savedSchedules],await ke(m.savedSchedules),me(e,m.savedSchedules),e.savedDropdown&&(e.savedDropdown.open=!0)}),f(e.savedMenu,"click",async a=>{const u=a.target.closest("[data-action]");if(!u)return;const p=u.closest(".schedule-saved-card")?.dataset.id;if(!p)return;if(u.dataset.action==="delete"){const v=m.savedSchedules.find(x=>x.id===p);if(!v||!await d({title:"Permanently Delete Schedule?",message:`This action will permanently delete "${v.name}".`,confirmLabel:"Delete",showInput:!1,showCancel:!0}))return;m.savedSchedules=m.savedSchedules.filter(x=>x.id!==p),await ke(m.savedSchedules),me(e,m.savedSchedules);return}const S=m.savedSchedules.find(v=>v.id===p);S&&(m.courses=[...S.courses],m.filtered=[...S.courses],e.search.value="",ee(m.sort.key||"code"),Q(e,m.filtered),o(),s("schedule"),e.savedDropdown&&(e.savedDropdown.open=!1))}),f(e.settingsBtn,"click",()=>{e.widget.classList.remove("is-hidden"),e.button.classList.remove("is-collapsed"),s("settings")}),f(e.helpBtn,"click",()=>{e.widget.classList.remove("is-hidden"),e.button.classList.remove("is-collapsed"),s("help")}),f(e.search,"input",Ue(()=>{xe(e.search.value),ee(m.sort.key||"code"),Q(e,m.filtered),o()},100)),ot(e),m.savedSchedules=await It(),me(e,m.savedSchedules),m.courses=await Le(),m.filtered=[...m.courses],ee("code"),Q(e,m.filtered),o(),s(m.view.panel)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t()})();
//# sourceMappingURL=content.js.map
