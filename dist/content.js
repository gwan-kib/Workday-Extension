const j=(t,n)=>Array.from(t.querySelectorAll(n)),C=(t,n,e,o)=>t&&t.addEventListener(n,e,o),wt=(t,n=300)=>{let e;return(...o)=>{clearTimeout(e),e=setTimeout(()=>t(...o),n)}},m={courses:[],filtered:[],savedSchedules:[],sort:{key:null,dir:1},view:{panel:"list",semester:"first"}},st="wd-courses-capture";function Ct(){let t=document.getElementById(st);return t||(t=document.createElement("div"),t.id=st,t.style.all="initial",t.style.position="fixed",t.style.bottom="16px",t.style.right="16px",t.style.zIndex="2147483647",t.attachShadow({mode:"open"}),document.documentElement.appendChild(t)),t.shadowRoot}async function xt(t){const n=chrome.runtime.getURL("src/panel.html"),e=["formatting/general.css","formatting/widget-shell.css","formatting/widget-buttons.css","formatting/floating-button.css","formatting/course-list.css","formatting/schedule-view.css","formatting/schedule-view-events.css","formatting/settings.css","colors/course-list-colors.css","colors/general-colors.css","colors/schedule-view-colors.css","colors/widget-functionality-colors.css","colors/settings-colors.css"],[o,...s]=await Promise.all([fetch(n).then(c=>c.text()),...e.map(c=>fetch(chrome.runtime.getURL(`src/css/${c}`)).then(d=>d.text()))]),r=s.join(`
`);t.innerHTML="";const a=document.createElement("style");if(a.textContent=r,t.appendChild(a),!document.querySelector('link[href*="Material+Symbols"]')){const c=document.createElement("link");c.rel="stylesheet",c.href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200",document.head.appendChild(c)}const i=document.createElement("div");return i.innerHTML=o,t.appendChild(i),{button:t.querySelector("#floating-button"),widget:t.querySelector(".widget"),root:t,search:t.querySelector("#widget-search"),saveScheduleBtn:t.querySelector("#widget-save-schedule"),refresh:t.querySelector("#widget-refresh"),exportDropdown:t.querySelector("#widget-export"),exportButton:t.querySelector("#widget-export-button"),exportMenu:t.querySelector("#widget-export-menu"),helpBtn:t.querySelector(".help"),settingsBtn:t.querySelector(".settings"),tableBody:t.querySelector("tbody"),tableHead:t.querySelector("thead"),tabButtons:t.querySelectorAll(".tab-button"),panels:t.querySelectorAll(".widget-panel"),scheduleGrid:t.querySelector("#schedule-grid"),semesterButtons:t.querySelectorAll(".semester-button"),savedDropdown:t.querySelector("#schedule-saved-dropdown"),savedMenu:t.querySelector("#schedule-saved-menu"),footerConflicts:t.querySelector("#widget-conflicts"),saveModal:t.querySelector("#schedule-save-modal"),saveModalTitle:t.querySelector("#schedule-modal-title"),saveModalMessage:t.querySelector("#schedule-modal-message"),saveModalField:t.querySelector("#schedule-modal-field"),saveModalInput:t.querySelector("#schedule-modal-input"),saveModalCancel:t.querySelector(".schedule-modal-cancel"),saveModalConfirm:t.querySelector(".schedule-modal-confirm")}}const Q=t=>String(t||"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim().toLowerCase();function Lt(t){const e=(t?.getAttribute?.("data-automation-id")||"").match(/^columnHeader(\d+\.\d+)$/);return e?e[1]:null}function Mt(t){const e=Array.from(t.querySelectorAll('th[data-automation-id^="columnHeader"]')).map((i,c)=>{const d=ft(i),u=Lt(i);return{el:i,pos:c,key:u,text:d,norm:Q(d)}}).filter(i=>i.text);function o(i){const c=i.map(Q);let d=e.find(u=>c.includes(u.norm));return d||(d=e.find(u=>c.some(l=>u.norm.includes(l))),d||null)}const s={instructor:["instructor","instructors"],meeting:["meeting patterns","meeting pattern"],deliveryMode:["delivery mode"],title:["title","course listing"],section:["section"],instructionalFormat:["instructional format"],startDate:["start date","start"]},r={},a={};for(const[i,c]of Object.entries(s)){const d=o(c);r[i]=d?d.key:null,a[i]=d?d.pos:-1}return{colMap:r,posMap:a}}function ft(t){if(!t)return"";const n=t.querySelector("button[title]");return n?(n.getAttribute("title")||"").trim():(t.textContent||"").trim()}function Tt(t){let n=String(t||"").replace(/\u00A0/g," ").trim();if(!n)return null;n=n.replace(/\s*\n\s*/g," ").trim();const e=n.match(/^\s*([A-Z][A-Z0-9_]*\s*\d{3}[A-Z]?)\s*-\s*(.+?)\s*$/);if(!e)return null;const o=e[1].trim(),r=e[2].trim().split(/\s*[-–—]\s*/).map(c=>c.trim()).filter(Boolean);let a="",i="";return a=r[0],i=r.slice(1).join(" - ").trim(),i=i.replace(/\s*:\s*/g,`:
`),{code:o,section_number:a,title:i,full:n}}function K(t){const n=String(t||"").match(/[A-Z][A-Z0-9_]*\s*\d{2,3}[A-Z]?/);return n?n[0].replace(/\s+/g," ").trim():""}function Dt(t){if(!t)return[];let e=Array.from(t.querySelectorAll('[data-automation-id="menuItem"][aria-label]')).map(a=>(a.getAttribute("aria-label")||"").trim()).filter(Boolean);e.length||(e=Array.from(t.querySelectorAll('[data-automation-id="promptOption"]')).map(i=>(i.getAttribute("data-automation-label")||i.getAttribute("title")||i.textContent||"").trim()).filter(Boolean)),e.length||(e=String(t.innerText||"").split(`
`).map(a=>a.trim()).filter(Boolean));const o=/\b\d{4}-\d{2}-\d{2}\s*-\s*\d{4}-\d{2}-\d{2}\b/,s=/\b\d{1,2}:\d{2}\s*[ap]\.?m\.?\b/i,r=/\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/i;return e.filter(a=>o.test(a)&&s.test(a)&&r.test(a))}function At(t){if(!t)return[];const e=Array.from(t.querySelectorAll('[data-automation-id="menuItem"][aria-label]')).map(a=>(a.getAttribute("aria-label")||"").trim()).filter(Boolean),o=/\b\d{4}-\d{2}-\d{2}\s*-\s*\d{4}-\d{2}-\d{2}\b/,s=/\b\d{1,2}:\d{2}\s*[ap]\.?m\.?\b/i,r=/\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/i;return e.filter(a=>o.test(a)&&s.test(a)&&r.test(a))}function $t(t){const n=String(t||""),e=n.split("|").map(l=>l.trim()).filter(Boolean),s=(e.find(l=>/\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/.test(l))||"").split(/\s+/).join(" / "),r=e.find(l=>/\d{1,2}:\d{2}/.test(l)&&/-/.test(l))||"",a=e.find(l=>/\([A-Z]{2,}\)/.test(l))||"",i=n.match(/\bfloor\b\s*[:\-]?\s*(-?[A-Za-z0-9]+)/i),c=n.match(/\b(room|rm)\b\s*[:\-]?\s*([A-Za-z0-9]+)/i),d=i?`Floor: ${i[1]}`:"",u=c?`Room: ${c[2]}`:"";return{days:s,time:r,location:[a,[d,u].filter(Boolean).join(" | ")].filter(Boolean).join(`
`)}}function It(t){return String(t||"").split(/\r?\n/).map(n=>n.replace(/\s+/g," ").trim()).filter(Boolean).join(`
`)}function tt(t){const n=String(t||"").match(/\b(\d{4}-\d{2}-\d{2})\b/);return n?n[1]:""}function Rt(t){if(!t)return"";const n=t.querySelector('[data-automation-id="promptOption"]');return(n&&(n.getAttribute("data-automation-label")||n.getAttribute("title")||n.textContent)||t.textContent||"").trim()}function Bt(t){if(!t)return!1;const n=(t.innerText||t.textContent||"").trim();return/online learning/i.test(n)?!0:Array.from(t.querySelectorAll('[data-automation-id="promptOption"]')).some(o=>{const s=(o.getAttribute("data-automation-label")||o.getAttribute("title")||o.textContent||"").trim();return/online learning/i.test(s)})}function kt(){const t=j(document,'table, [role="table"], div[data-automation-id*="grid"], div[role="grid"]');for(const n of t){const o=j(n,"thead th, [role='columnheader'], .wd-GridHeaderCell, .grid-column-header").map(a=>Q(ft(a)));if(!(o.some(a=>a.includes("section"))&&(o.some(a=>a.includes("instructor"))||o.some(a=>a.includes("meeting"))||o.some(a=>a.includes("instructional format"))||o.some(a=>a.includes("format"))||o.some(a=>a.includes("status")))))continue;const r=j(n,"tbody tr, [role='rowgroup'] [role='row'], .wd-GridRow, .grid-row");if(r.length)return{root:n,rows:r}}return null}async function rt(){const t=kt();let n=[];if(t){const e=Mt(t.root);for(const o of t.rows){const s=Ft(o,e);(s.code||s.title)&&Object.values(s).join("").trim()&&n.push(s)}}return Nt(n)}function Nt(t){const n=s=>[s.code,s.title,s.section_number].join("|").toLowerCase(),e=new Set,o=[];for(const s of t){const r=n(s);e.has(r)||(e.add(r),o.push(s))}return o}function Ft(t,n){const{colMap:e,posMap:o}=n,s=j(t,"td, [role='gridcell']"),r=(t.innerText||"").trim();function a(y){const ot=(y.querySelector('[id^="gen-dwr-comp-"]')?.id||"").match(/^gen-dwr-comp-(\d+\.\d+)-/);return ot?ot[1]:null}const i=new Map;s.forEach(y=>{const T=a(y);T&&!i.has(T)&&i.set(T,y)});const c=y=>{const T=e[y];if(T!=null&&i.has(T))return i.get(T);const N=o[y];return N!=null&&N>=0&&N<s.length?s[N]:null},d=y=>{const T=e[y];if(T!=null&&i.has(T))return(i.get(T).innerText||"").trim();const N=o[y];return N!=null&&N>=0&&N<s.length?(s[N].innerText||"").trim():""},u=j(t,'[data-automation-id="promptOption"]');let l=null;for(const y of u){const T=y.getAttribute("data-automation-label")||y.getAttribute("title")||y.getAttribute("aria-label")||y.textContent||"";if(/^[A-Z][A-Z0-9_]*\s*\d{2,3}-/.test(T)){l=y;break}}!l&&u.length>0&&(l=u[0]);const p=l&&(l.getAttribute("data-automation-label")||l.getAttribute("title")||l.getAttribute("aria-label")||l.textContent)||"",S=d("title"),g=d("code"),x=d("section"),M=d("meeting"),I=d("instructionalFormat"),B=d("startDate");let _="",$=S||"",G="";const H=Tt(p);H&&(_=H.code,G=H.section_number,$=H.title),_||(_=K(g)||K(S)||K(r)||"");const O=y=>/\b(lab|laboratory|labratory)\b/i.test(String(y||"")),F=y=>/\bseminar\b/i.test(String(y||"")),R=y=>/\bdiscussion\b/i.test(String(y||"")),D=O(I)||O(x)||O($)||O(p)||O(r),k=F(I)||F(x)||F($)||F(p)||F(r),L=R(I)||R(x)||R($)||R(p)||R(r),h=c("instructor");let v="";D||k?v="N/A":v=Rt(h)||(d("instructor")||"").trim();let E;const A=e.meeting;let f=null;A!=null&&i.has(A)?f=i.get(A):o.meeting!=null&&o.meeting>=0&&o.meeting<s.length&&(f=s[o.meeting]);let b=f?Dt(f):[];b.length||(b=At(t));let w={days:"",time:"",location:""},U=tt(b[0])||tt(B);if(b.length){const y=b[0];w=$t(y)}else E=(M||"").trim();const V=c("deliveryMode");Bt(V)&&(w.location="Online"),w.days||w.time||w.location?(E=[w.days,w.time].filter(Boolean).join(" | "),w.location?E+=`
${w.location}`:E+=`
Online`):E=(M||"").trim();const Et=(I||"").trim();return{code:_,title:$,section_number:G,instructor:v,meeting:It(E),instructionalFormat:Et,startDate:U,meetingLines:b,isLab:D,isSeminar:k,isDiscussion:L}}const it=t=>String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");function Ot(t){return String(t||"").replace(/[\u00A0\u200B-\u200D\uFEFF]/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n[ \t]+/g,`
`).replace(/\n{2,}/g,`
`).trim()}function W(t,n){t.tableBody.innerHTML="";const e=document.createDocumentFragment();n.forEach(o=>{const s=document.createElement("tr"),r=o.isLab?"[Laboratory]":o.isSeminar?"[Seminar]":o.isDiscussion?"[Discussion]":"";s.innerHTML=`
      <td class="title">
        <div class="title-main">${o.title||""}</div>
        ${r?`<div class="muted">${r}</div>`:""}
      </td>
      <td class="code">${o.code||""}</td>
      <td class="sect">${(o.section_number||"").trim()}</td>
      <td class="instructor">${o.instructor||""}</td>
      <td class="meeting">
        ${(()=>{const a=Ot(o.meeting).split(`
`),i=(a[0]||"").trim(),c=a.slice(1).map(d=>d.replace(/[\u00A0\u200B-\u200D\uFEFF]/g,"").trim()).filter(Boolean).join(`
`);return`
            ${i?`<span class="meeting-pill">${it(i).trim()}</span>`:""}
            ${c?`<div class="meeting-sub">${it(c).trim()}</div>`:""}
          `})()}
      </td>
      <td class="instructionalFormat">${o.instructionalFormat||""}</td>
    `,e.appendChild(s)}),t.tableBody.appendChild(e)}function at(t){if(t=(t||"").trim().toLowerCase(),!t){m.filtered=[...m.courses];return}m.filtered=m.courses.filter(n=>["code","title","section_number","instructor","meeting","instructionalFormat"].some(e=>(n[e]||"").toLowerCase().includes(t)))}function Y(t){if(!t)return;const n=m.sort.key===t?-m.sort.dir:1;m.sort={key:t,dir:n};const e=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});m.filtered.sort((o,s)=>n*e.compare(o[t]||"",s[t]||""))}function qt(t){const n=j(t.tableHead,"th[data-key]");n.forEach(e=>{C(e,"click",()=>{const o=e.getAttribute("data-key");Y(o),W(t,m.filtered),n.forEach(s=>s.classList.remove("sorted-asc","sorted-desc")),e.classList.add(m.sort.dir===1?"sorted-asc":"sorted-desc")})})}const q=["Mon","Tue","Wed","Thu","Fri"],gt=8,nt=21,X=30,P=[];for(let t=gt;t<nt;t++)P.push(t*60),P.push(t*60+30);P.push(nt*60);const Pt=/\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/g,_t=/(\d{1,2}):(\d{2})\s*([ap])\.?m\.?/gi,lt={first:["09","08"],second:["01","12"]};function ct(t){if(!t)return null;const n=t.trim().match(/(\d{1,2}):(\d{2})\s*([ap])\.?m\.?/i);if(!n)return null;let e=Number.parseInt(n[1],10);const o=Number.parseInt(n[2],10),s=n[3].toLowerCase();return s==="p"&&e!==12&&(e+=12),s==="a"&&e===12&&(e=0),e*60+o}function Ht(t){const n=String(t||"").match(Pt)||[],e=String(t||"").match(_t)||[];if(n.length===0||e.length<2)return null;const o=ct(e[0]),s=ct(e[1]);return o==null||s==null||s<=o?null:{days:[...new Set(n)],startMinutes:o,endMinutes:s,timeLabel:`${e[0]} - ${e[1]}`}}function Ut(t){if(!t)return null;const n=t.split("-")[1];return lt.first.includes(n)?"first":lt.second.includes(n)?"second":null}function dt(t){const n=gt*60,e=nt*60;return Math.max(n,Math.min(e,t))}function jt(t){return Math.floor(t/X)*X}function Gt(t){return Math.ceil(t/X)*X}function ut(t){return P.indexOf(t)}function Wt(t,n){const e=new Map;q.forEach(r=>e.set(r,[]));const o=new Set;let s=0;return t.forEach(r=>{const a=r.startDate||tt(r.meetingLines?.[0])||"",i=Ut(a);if(i!==i)return;const c=r.meetingLines?.length?r.meetingLines:[],d=r.isLab?"[Laboratory]":r.isSeminar?"[Seminar]":r.isDiscussion?"[Discussion]":"";c.forEach(u=>{const l=Ht(u);if(!l)return;let p=dt(l.startMinutes),S=dt(l.endMinutes);p=jt(p),S=Gt(S);const g=ut(p),x=ut(S);if(g===-1||x===-1||x<=g)return;const M=x-g;l.days.forEach(I=>{if(!e.has(I))return;const B=[I,r.code||"",r.title||"",l.timeLabel,g,M].join("|");o.has(B)||(o.add(B),e.get(I).push({id:s++,code:r.code||"",title:r.title||"",label:d,timeLabel:l.timeLabel,rowStart:g,rowSpan:M,startIdx:g,endIdx:x}))})})}),q.forEach(r=>{e.get(r).sort((a,i)=>a.startIdx-i.startIdx||a.endIdx-i.endIdx)}),e}function Yt(t){const n=new Map;return q.forEach(e=>{const o=(t.get(e)||[]).slice().sort((i,c)=>i.startIdx-c.startIdx||i.endIdx-c.endIdx),s=[];let r=null,a=null;for(let i=0;i<P.length-1;i++){const c=o.filter(u=>u.startIdx<=i&&u.endIdx>i),d=c.length?c.map(u=>u.id).sort((u,l)=>u-l).join("|"):null;if(!d){r&&s.push(r),r=null,a=null;continue}if(r&&d===a){r.end=i+1;continue}r&&s.push(r),r={start:i,end:i+1,events:c,hasConflict:c.length>1},a=d}r&&s.push(r),n.set(e,s)}),n}function zt(t){const n=new Set,e=[];return t.forEach(o=>{o.forEach(s=>{if(!s.hasConflict)return;const r=[...new Set(s.events.map(i=>i.code||i.title).filter(Boolean))];if(r.length<2)return;r.sort((i,c)=>i.localeCompare(c));const a=r.join("|");n.has(a)||(n.add(a),e.push(r))})}),e}function Xt(t,n){if(!t?.footerConflicts)return;if(!n.length){t.footerConflicts.textContent="";return}const e=n.map(o=>`[${o.join(", ")}]`).join(" ");t.footerConflicts.textContent=`⚠️ The following classes are in conflict: ${e}`}function Zt(t){const n=Math.floor(t/60),e=t%60,o=String(n),s=String(e).padStart(2,"0");return`${o}:${s}`}function Vt(){const t=document.createElement("div");t.className="schedule-table-wrap";const n=document.createElement("table");n.className="schedule-table";const e=document.createElement("thead"),o=document.createElement("tr");o.innerHTML=`
    <th class="schedule-time"></th>
    ${q.map(a=>`<th class="schedule-day-head" data-day="${a}">${a}</th>`).join("")}
  `,e.appendChild(o),n.appendChild(e);const s=document.createElement("tbody");for(let a=0;a<P.length;a++){const i=document.createElement("tr"),c=document.createElement("td");c.className="schedule-time",c.textContent=Zt(P[a]),i.appendChild(c),q.forEach(d=>{const u=document.createElement("td");u.className="schedule-cell",u.dataset.day=d,u.dataset.row=String(a);const l=document.createElement("div");l.className="schedule-cell-inner",u.appendChild(l),i.appendChild(u)}),s.appendChild(i)}n.appendChild(s),t.appendChild(n);const r=document.createElement("div");return r.className="schedule-overlay",t.appendChild(r),t}function yt(t,n){return!(t.right<=n.left||t.left>=n.right||t.bottom<=n.top||t.top>=n.bottom)}function Kt(t,n){const e=Math.max(t.left,n.left),o=Math.min(t.right,n.right),s=Math.max(t.top,n.top),r=Math.min(t.bottom,n.bottom);return o<=e||r<=s?null:{left:e,right:o,top:s,bottom:r,width:o-e,height:r-s}}function Jt(t){const n=parseFloat(t.style.left)||0,e=parseFloat(t.style.top)||0,o=parseFloat(t.style.width)||0,s=parseFloat(t.style.height)||0;return{left:n,top:e,right:n+o,bottom:e+s,width:o,height:s}}function Qt(t,n){for(const e of n)if(yt(t,e))return!0;return!1}function te(t,n,e,o){const s=t.querySelector(".schedule-overlay");s.innerHTML="";const r=t.querySelector(".schedule-table"),a=r.querySelector("tbody tr"),i=r.querySelector('tbody tr td.schedule-cell[data-day="Mon"]'),c=r.querySelector("thead th.schedule-time");if(!a||!i||!c)return;const d=c.getBoundingClientRect().width,u=i.getBoundingClientRect().width,l=r.querySelector("thead").getBoundingClientRect().height,p=a.getBoundingClientRect().height,S=getComputedStyle(i),g=parseFloat(S.borderLeftWidth)||0,x=parseFloat(S.borderTopWidth)||0,M=parseFloat(S.borderRightWidth)||0,I=parseFloat(S.borderBottomWidth)||0,B=(g+M)/2,_=(x+I)/2,$=[];q.forEach((D,k)=>{(n.get(D)||[]).forEach(h=>{const v=d+k*u,E=l+h.rowStart*p,A=h.rowSpan*p,f=document.createElement("div");f.className="schedule-entry-float",f.style.left=`${v+g}px`,f.style.top=`${E+x}px`,f.style.width=`${u-B}px`,f.style.height=`${A-_}px`;const b=document.createElement("div");b.className="schedule-entry-overlap-layer",f.appendChild(b);const w=document.createElement("div");w.className="schedule-entry-text";const U=h.code||h.title,V=h.label?`${U} ${h.label}`:U;w.innerHTML=`
        <div class="schedule-entry-title">${V}</div>
        <div class="schedule-entry-time">${h.timeLabel}</div>
      `,f.appendChild(w),s.appendChild(f),$.push({el:f,day:D,ev:h,rect:Jt(f),overlapLayerEl:b,overlaps:[],textEl:w})})});const G=D=>{};for(let D=0;D<$.length;D++)for(let k=D+1;k<$.length;k++){const L=$[D],h=$[k];if(L.day!==h.day||!yt(L.rect,h.rect))continue;const v=Kt(L.rect,h.rect);if(!v)continue;L.el.style.opacity="0.75",h.el.style.opacity="0.75",L.el.classList.add("is-overlap"),h.el.classList.add("is-overlap"),G(L.el),G(h.el);const E={left:v.left-L.rect.left,top:v.top-L.rect.top,width:v.width,height:v.height},A={left:v.left-h.rect.left,top:v.top-h.rect.top,width:v.width,height:v.height},f=document.createElement("div");f.className="schedule-entry-overlap-rect",f.style.left=`${E.left}px`,f.style.top=`${E.top}px`,f.style.width=`${E.width}px`,f.style.height=`${E.height}px`,L.overlapLayerEl.appendChild(f);const b=document.createElement("div");b.className="schedule-entry-overlap-rect",b.style.left=`${A.left}px`,b.style.top=`${A.top}px`,b.style.width=`${A.width}px`,b.style.height=`${A.height}px`,h.overlapLayerEl.appendChild(b)}const H=25,O=30,F=6,R=0;q.forEach(D=>{const k=$.filter(h=>h.day===D).sort((h,v)=>h.rect.top-v.rect.top),L=[];k.forEach(h=>{const v=h.rect.left+F;let E=h.rect.top+R,A=0;const f=h.rect.width-F*2,b=26;for(;A<O;){const w={left:v,top:E,right:v+f,bottom:E+b};if(w.bottom>h.rect.bottom-R)break;if(!Qt(w,L)){const U=E-h.rect.top;h.textEl.style.transform=`translateY(${U}px)`,L.push(w);return}E+=H,A++}h.textEl.style.transform=`translateY(${R}px)`,L.push({left:v,top:h.rect.top+R,right:v+f,bottom:h.rect.top+R+b})})})}function ee(t,n,e){if(!t.scheduleGrid)return;t.scheduleGrid.innerHTML="";const o=Wt(n),s=Yt(o),r=zt(s),a=Vt();t.scheduleGrid.appendChild(a),te(a,o),Xt(t,r)}const St={Mon:"MO",Tue:"TU",Wed:"WE",Thu:"TH",Fri:"FR",Sat:"SA",Sun:"SU"},ne=/(\d{4}-\d{2}-\d{2})\s*-\s*(\d{4}-\d{2}-\d{2})/,oe=/(\d{1,2}):(\d{2})\s*([ap])\.?m\.?\s*-\s*(\d{1,2}):(\d{2})\s*([ap])\.?m\.?/i,se=/\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b/g,Z=t=>String(t).padStart(2,"0"),re=t=>{const n=t.getFullYear(),e=Z(t.getMonth()+1),o=Z(t.getDate());return`${n}${e}${o}`},mt=t=>{const n=re(t),e=Z(t.getHours()),o=Z(t.getMinutes());return`${n}T${e}${o}00`},pt=(t,n,e)=>{let o=Number.parseInt(t,10);const s=Number.parseInt(n,10),r=e.toLowerCase();return r==="p"&&o!==12&&(o+=12),r==="a"&&o===12&&(o=0),{hours:o,minutes:s}},ie=t=>{const n=String(t||"").match(ne),e=String(t||"").match(oe),o=String(t||"").match(se)||[];if(!n||!e||!o.length)return null;const s=n[1],r=n[2],a=pt(e[1],e[2],e[3]),i=pt(e[4],e[5],e[6]),c=[...new Set(o.map(d=>St[d]).filter(Boolean))];return{startDate:s,endDate:r,days:c,startTime:a,endTime:i}},ae=t=>{const n=String(t||"").split("|").map(s=>s.trim()).filter(Boolean),e=n.find(s=>/\([A-Z]{2,}\)/.test(s));if(e)return e;const o=n.find(s=>/online/i.test(s));return o||""},le=(t,n)=>{const e=new Date(`${t}T00:00:00`);for(let o=0;o<7;o+=1){const s=new Date(e);s.setDate(e.getDate()+o);const r=Object.values(St)[s.getDay()===0?6:s.getDay()-1];if(n.includes(r))return s}return e},ce=(t,n)=>{const e=ie(n);if(!e)return null;const o=le(e.startDate,e.days),s=new Date(o);s.setHours(e.startTime.hours,e.startTime.minutes,0,0);const r=new Date(o);r.setHours(e.endTime.hours,e.endTime.minutes,0,0);const a=[t.code,t.title].filter(Boolean),i=[t.title?`Title: ${t.title}`:null,t.code?`Code: ${t.code}`:null,t.section_number?`Section: ${t.section_number}`:null,t.instructor?`Instructor: ${t.instructor}`:null,t.instructionalFormat?`Format: ${t.instructionalFormat}`:null,t.meeting?`Meeting: ${t.meeting}`:null].filter(Boolean),c=`${e.endDate.replace(/-/g,"")}T235959`;return{uid:`${t.code||"course"}-${Date.now()}-${Math.random().toString(16).slice(2)}`,summary:a.join(" - ")||"Scheduled Course",description:i.join("\\n"),location:ae(n),dtstart:mt(s),dtend:mt(r),rrule:`FREQ=WEEKLY;BYDAY=${e.days.join(",")};UNTIL=${c}`}},de=t=>{const n=[];t.forEach(o=>{(o.meetingLines?.length?o.meetingLines:[]).forEach(r=>{const a=ce(o,r);a&&n.push(a)})});const e=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Workday Extension//Schedule Export//EN","CALSCALE:GREGORIAN"];return n.forEach(o=>{e.push("BEGIN:VEVENT"),e.push(`UID:${o.uid}`),e.push(`SUMMARY:${o.summary}`),o.description&&e.push(`DESCRIPTION:${o.description}`),o.location&&e.push(`LOCATION:${o.location}`),e.push(`DTSTART:${o.dtstart}`),e.push(`DTEND:${o.dtend}`),e.push(`RRULE:${o.rrule}`),e.push("END:VEVENT")}),e.push("END:VCALENDAR"),e.join(`\r
`)};function ue(){const t=de(m.filtered||[]),n=new Blob([t],{type:"text/calendar;charset=utf-8"}),e=URL.createObjectURL(n),o=document.createElement("a");o.href=e,o.download="workday-schedule.ics",document.body.appendChild(o),o.click(),setTimeout(()=>{URL.revokeObjectURL(e),o.remove()},100)}const me=({schedulePanel:t,listPanel:n,styleText:e})=>{const o=document.createElement("div");o.className="export-image",o.style.display="flex",o.style.flexDirection="column",o.style.gap="18px",o.style.padding="18px",o.style.background="#ffffff",o.style.color="#111827";const s=document.createElement("h2");s.textContent="Schedule View",s.style.margin="0",s.style.fontSize="18px",s.style.fontWeight="700";const r=t.cloneNode(!0);r.classList.add("is-active"),r.style.display="flex",r.style.flexDirection="column",r.style.height="auto",r.style.minHeight="auto";const a=r.querySelector(".schedule-grid");a&&(a.style.overflow="visible",a.style.maxHeight="none");const i=document.createElement("h2");i.textContent="Course List",i.style.margin="8px 0 0",i.style.fontSize="18px",i.style.fontWeight="700";const c=n.cloneNode(!0);c.classList.add("is-active"),c.style.display="block";const d=document.createElement("style");d.textContent=e;const u=document.createElement("div");return u.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),u.appendChild(d),u.appendChild(o),o.appendChild(s),o.appendChild(r),o.appendChild(i),o.appendChild(c),{wrapper:u,container:o}},pe=async({wrapper:t,container:n})=>{const e=document.createElement("div");e.style.position="fixed",e.style.top="-99999px",e.style.left="-99999px",e.style.pointerEvents="none",e.style.opacity="0",e.appendChild(t),document.body.appendChild(e);const o=Math.ceil(n.scrollWidth),s=Math.ceil(n.scrollHeight);t.querySelectorAll(".material-symbols-rounded").forEach(l=>{l.remove()});const r=new XMLSerializer().serializeToString(t),a=`
    <svg xmlns="http://www.w3.org/2000/svg" width="${o}" height="${s}">
      <foreignObject width="100%" height="100%">
        ${r}
      </foreignObject>
    </svg>
  `,i=new Blob([a],{type:"image/svg+xml;charset=utf-8"}),c=URL.createObjectURL(i),d=new Image,u=await new Promise((l,p)=>{d.onload=()=>{const S=document.createElement("canvas");S.width=o,S.height=s;const g=S.getContext("2d");if(!g){p(new Error("Unable to create canvas context."));return}g.fillStyle="#ffffff",g.fillRect(0,0,o,s),g.drawImage(d,0,0),l(S.toDataURL("image/png"))},d.onerror=()=>p(new Error("Unable to render export image.")),d.src=c});return URL.revokeObjectURL(c),e.remove(),u};async function he(t){const n=t.root.querySelector('[data-panel="schedule"]'),e=t.root.querySelector('[data-panel="list"]'),o=Array.from(t.root.querySelectorAll("style")).map(c=>c.textContent).join(`
`);if(!n||!e)return;const{wrapper:s,container:r}=me({schedulePanel:n,listPanel:e,styleText:o}),a=await pe({wrapper:s,container:r}),i=document.createElement("a");i.href=a,i.download="workday-schedule.png",document.body.appendChild(i),i.click(),i.remove()}const z="wdSavedSchedules",vt=6,fe=t=>typeof structuredClone=="function"?structuredClone(t):JSON.parse(JSON.stringify(t||[])),et=t=>Array.isArray(t)?t.filter(n=>n&&Array.isArray(n.courses)).map(n=>({id:n.id,name:n.name||"Untitled",savedAt:n.savedAt||new Date().toISOString(),courses:n.courses})):[],bt=typeof chrome<"u"&&chrome.storage&&chrome.storage.local;async function ge(){if(bt)return new Promise(t=>{chrome.storage.local.get([z],n=>{t(et(n?.[z]||[]))})});try{const t=localStorage.getItem(z);return t?et(JSON.parse(t)):[]}catch(t){return console.warn("[WD] Failed to load saved schedules",t),[]}}async function ht(t){const n=et(t);if(bt)return new Promise(e=>{chrome.storage.local.set({[z]:n},e)});try{localStorage.setItem(z,JSON.stringify(n))}catch(e){console.warn("[WD] Failed to save schedules",e)}}function ye(t,n){return{id:typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,name:t||"Untitled",savedAt:new Date().toISOString(),courses:fe(n||[])}}function Se(t){const n=t.courses?.length||0,e=new Date(t.savedAt),o=Number.isNaN(e.getTime())?t.savedAt:e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});return`${n} courses · Saved ${o}`}function J(t,n){if(t.savedMenu){if(t.savedMenu.innerHTML="",!n.length){const e=document.createElement("div");e.className="schedule-saved-empty",e.textContent="No saved schedules yet.",t.savedMenu.appendChild(e);return}n.forEach(e=>{const o=document.createElement("div");o.className="schedule-saved-card",o.dataset.id=e.id;const s=document.createElement("div");s.className="schedule-saved-card-header";const r=document.createElement("div"),a=document.createElement("div");a.className="schedule-saved-title",a.textContent=e.name;const i=document.createElement("div");i.className="schedule-saved-meta",i.textContent=Se(e),r.appendChild(a),r.appendChild(i),s.appendChild(r);const c=document.createElement("div");c.className="schedule-saved-actions";const d=document.createElement("button");d.type="button",d.className="schedule-saved-action",d.dataset.action="load",d.textContent="Load";const u=document.createElement("button");u.type="button",u.className="schedule-saved-action delete",u.dataset.action="delete",u.textContent="Delete",c.appendChild(d),c.appendChild(u),o.appendChild(s),o.appendChild(c),t.savedMenu.appendChild(o)})}}function ve(t){return t.length<vt}function be(){return vt}(()=>{console.log("[WD] content script loaded");async function t(){const n=Ct(),e=await xt(n);e.button.classList.toggle("is-collapsed",e.widget.classList.contains("is-hidden"));const o=()=>{ee(e,m.filtered)},s=l=>{m.view.panel=l,e.panels.forEach(p=>{p.classList.toggle("is-active",p.dataset.panel===l)}),e.tabButtons.forEach(p=>{p.classList.toggle("is-active",p.dataset.panel===l)}),e.widget.classList.toggle("is-schedule-view",l==="schedule"),e.widget.classList.toggle("is-settings-view",l==="settings"),e.widget.classList.toggle("is-help-view",l==="help")},r=()=>{e.widget.classList.toggle("is-hidden"),e.button.classList.toggle("is-collapsed",e.widget.classList.contains("is-hidden"))};let a=null;const i=l=>{e.saveModal&&(e.saveModal.classList.add("is-hidden"),e.saveModal.setAttribute("aria-hidden","true"),a&&(a(l),a=null))},c=({title:l,message:p,confirmLabel:S="Save",showInput:g=!0,showCancel:x=!0})=>e.saveModal?(e.saveModalTitle.textContent=l,e.saveModalMessage.textContent=p,e.saveModalConfirm.textContent=S,e.saveModalField.classList.toggle("is-hidden",!g),e.saveModalCancel.classList.toggle("is-hidden",!x),e.saveModalInput.value="",e.saveModalInput.classList.remove("is-invalid"),e.saveModal.classList.remove("is-hidden"),e.saveModal.setAttribute("aria-hidden","false"),g?e.saveModalInput.focus():e.saveModalConfirm.focus(),new Promise(M=>{a=M})):Promise.resolve(null);e.saveModal&&(C(e.saveModal,"click",l=>{if(l.target===e.saveModal){i(null);return}const p=l.target.closest("[data-action]")?.dataset.action;if(p){if(p==="close"||p==="cancel"){i(null);return}if(p==="confirm"){if(!e.saveModalField.classList.contains("is-hidden")){const S=e.saveModalInput.value.trim();if(!S){e.saveModalInput.classList.add("is-invalid"),e.saveModalInput.focus();return}i(S);return}i(!0)}}}),C(e.saveModalInput,"input",()=>{e.saveModalInput.classList.remove("is-invalid")}),C(e.saveModalInput,"keydown",l=>{l.key==="Enter"&&e.saveModalConfirm.click()}),C(document,"keydown",l=>{l.key==="Escape"&&e.saveModal&&!e.saveModal.classList.contains("is-hidden")&&i(null)})),e.tabButtons.forEach(l=>{C(l,"click",()=>{s(l.dataset.panel),l.dataset.panel==="schedule"&&o()})}),e.semesterButtons.forEach(l=>{C(l,"click",()=>{m.view.semester=l.dataset.semester,e.semesterButtons.forEach(p=>{p.classList.toggle("is-active",p.dataset.semester===m.view.semester)}),o()})}),C(e.button,"click",r);const d=l=>{!e.exportDropdown||!e.exportButton||(e.exportDropdown.classList.toggle("is-open",l),e.exportButton.setAttribute("aria-expanded",String(l)))};C(e.exportButton,"click",()=>{const l=e.exportDropdown?.classList.contains("is-open");d(!l)}),C(document,"click",l=>{!e.exportDropdown?.classList.contains("is-open")||(l.composedPath?l.composedPath():[]).includes(e.exportDropdown)||d(!1)}),C(e.root,"click",l=>{!e.exportDropdown?.open||(l.composedPath?l.composedPath():[]).includes(e.exportDropdown)||(e.exportDropdown.open=!1)}),chrome.runtime.onMessage.addListener(l=>{l?.type==="TOGGLE_WIDGET"&&r()}),C(e.refresh,"click",async()=>{m.courses=await rt(),at(e.search.value),Y(m.sort.key||"code"),W(e,m.filtered),o()});const u=async l=>{l==="ics"&&ue(),l==="png"&&await he(e)};C(e.exportMenu,"click",async l=>{const p=l.target.closest("[data-export]");p&&(d(!1),await u(p.dataset.export))}),C(e.saveScheduleBtn,"click",async()=>{if(!ve(m.savedSchedules)){await c({title:"Schedule limit reached",message:`You can only save up to ${be()} schedules. Delete one to save another.`,confirmLabel:"Got it",showInput:!1,showCancel:!1});return}const l=await c({title:"Save schedule",message:"Name this schedule so you can find it later.",confirmLabel:"Save",showInput:!0,showCancel:!0});if(!l)return;const p=ye(l,m.filtered);m.savedSchedules=[p,...m.savedSchedules],await ht(m.savedSchedules),J(e,m.savedSchedules),e.savedDropdown&&(e.savedDropdown.open=!0)}),C(e.savedMenu,"click",async l=>{const p=l.target.closest("[data-action]");if(!p)return;const g=p.closest(".schedule-saved-card")?.dataset.id;if(!g)return;if(p.dataset.action==="delete"){const M=m.savedSchedules.find(B=>B.id===g);if(!M||!await c({title:"Permanently Delete Schedule?",message:`This action will permanently delete "${M.name}".`,confirmLabel:"Delete",showInput:!1,showCancel:!0}))return;m.savedSchedules=m.savedSchedules.filter(B=>B.id!==g),await ht(m.savedSchedules),J(e,m.savedSchedules);return}const x=m.savedSchedules.find(M=>M.id===g);x&&(m.courses=[...x.courses],m.filtered=[...x.courses],e.search.value="",Y(m.sort.key||"code"),W(e,m.filtered),o(),s("schedule"),e.savedDropdown&&(e.savedDropdown.open=!1))}),C(e.settingsBtn,"click",()=>{e.widget.classList.remove("is-hidden"),e.button.classList.remove("is-collapsed"),s("settings")}),C(e.helpBtn,"click",()=>{e.widget.classList.remove("is-hidden"),e.button.classList.remove("is-collapsed"),s("help")}),C(e.search,"input",wt(()=>{at(e.search.value),Y(m.sort.key||"code"),W(e,m.filtered),o()},100)),qt(e),m.savedSchedules=await ge(),J(e,m.savedSchedules),m.courses=await rt(),m.filtered=[...m.courses],Y("code"),W(e,m.filtered),o(),s(m.view.panel)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t()})();
//# sourceMappingURL=content.js.map
